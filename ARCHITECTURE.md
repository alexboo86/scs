# Архитектура Secure Content Service

## Обзор

Secure Content Service - это микросервис для защищенного показа контента (PDF, PPT/PPTX) с водяными знаками. Сервис разработан для интеграции в онлайн школы и другие образовательные платформы.

## Компоненты системы

### 1. Backend (FastAPI)

**Основные модули:**

- `app/main.py` - Точка входа приложения
- `app/core/` - Конфигурация и безопасность
- `app/models/` - Модели данных (SQLAlchemy) и схемы (Pydantic)
- `app/api/` - API endpoints
- `app/services/` - Бизнес-логика (конвертация, водяные знаки)
- `app/utils/` - Вспомогательные функции

**API Endpoints:**

- `/api/documents/` - Управление документами
- `/api/users/` - Управление пользователями
- `/api/viewer/` - Просмотр документов
- `/api/admin/` - Административные функции

### 2. Frontend (Viewer)

**Компоненты:**

- `frontend/templates/viewer.html` - Защищенный viewer с защитой от копирования
- JavaScript защита от скриншотов, выделения текста, горячих клавиш

### 3. База данных

**Модели:**

- `User` - Пользователи системы
- `Document` - Загруженные документы
- `DocumentAccess` - Доступы пользователей к документам
- `ViewingSession` - Сессии просмотра
- `StaticWatermark` - Статические водяные знаки (логотипы)

### 4. Docker

**Контейнеры:**

- `backend` - FastAPI приложение
- Volumes для персистентности данных

## Поток данных

### Загрузка документа

```
1. Клиент → POST /api/documents/upload
2. Сервер сохраняет файл
3. Сервер конвертирует в изображения (PDF/PPT → PNG)
4. Сервер сохраняет базовые изображения в кеш
5. Сервер создает запись в БД
6. Сервер возвращает access_token
```

### Просмотр документа

```
1. Клиент → POST /api/viewer/token (document_token, user_email)
2. Сервер проверяет доступ пользователя
3. Сервер создает viewing_session
4. Сервер возвращает viewer_token
5. Клиент открывает /viewer?token=viewer_token
6. Viewer запрашивает страницы через GET /api/documents/{id}/page/{num}
7. Сервер применяет водяные знаки к изображению
8. Сервер возвращает изображение с водяными знаками
```

## Система водяных знаков

### Статические водяные знаки

- Логотип школы
- Настраиваемое позиционирование
- Настраиваемый размер и прозрачность

### Динамические водяные знаки

- Email пользователя
- IP адрес
- Время просмотра
- Номер страницы
- Пользовательский текст

## Защита от копирования

### Клиентская защита (JavaScript)

1. **Блокировка выделения текста** - `user-select: none`
2. **Блокировка правого клика** - `contextmenu` event
3. **Блокировка горячих клавиш** - Ctrl+S, Ctrl+P, Print Screen, F12
4. **Обнаружение DevTools** - Проверка размеров окна
5. **Blur при потере фокуса** - Размытие контента
6. **Блокировка drag & drop** - Предотвращение перетаскивания

### Серверная защита

1. **Токенизированный доступ** - Каждая сессия имеет уникальный токен
2. **Ограниченное время жизни** - Токены истекают через 24 часа
3. **Проверка доступа** - Перед выдачей токена проверяется доступ пользователя
4. **Водяные знаки на сервере** - Водяные знаки применяются на сервере, не на клиенте
5. **Логирование доступа** - Фиксация всех просмотров страниц

## Масштабирование

### Горизонтальное масштабирование

1. **Stateless backend** - Сервер не хранит состояние в памяти
2. **Shared storage** - Общее хранилище для файлов и кеша (NFS, S3)
3. **Load balancer** - Распределение нагрузки между инстансами
4. **Database** - Использование PostgreSQL/MySQL вместо SQLite

### Оптимизация производительности

1. **Кеширование базовых изображений** - PDF конвертируется один раз
2. **Кеширование водяных знаков** - Изображения с водяными знаками кешируются по сессии
3. **Lazy loading** - Страницы загружаются по требованию
4. **Предзагрузка** - Следующая страница предзагружается в фоне

## Безопасность

### Рекомендации для продакшена

1. **HTTPS обязателен** - Все соединения должны быть зашифрованы
2. **Сильный SECRET_KEY** - Используйте криптографически стойкий ключ
3. **CORS настройки** - Ограничьте разрешенные домены
4. **Rate limiting** - Ограничьте количество запросов от одного IP
5. **Валидация входных данных** - Проверка всех загружаемых файлов
6. **Регулярные обновления** - Обновляйте зависимости для исправления уязвимостей

## Мониторинг

### Метрики для отслеживания

1. Количество загруженных документов
2. Количество активных сессий просмотра
3. Время отклика API
4. Использование дискового пространства
5. Ошибки конвертации

### Логирование

- Все загрузки документов
- Все создания сессий просмотра
- Все запросы страниц
- Ошибки конвертации и обработки

## Интеграция

### С вашим сайтом

1. **API интеграция** - Используйте REST API для управления
2. **iframe встраивание** - Встройте viewer через iframe
3. **CORS настройки** - Настройте разрешенные домены
4. **Аутентификация** - Интегрируйте с вашей системой аутентификации

Подробнее см. `INTEGRATION.md`

## Ограничения защиты

⚠️ **Важно понимать:**

Полная защита от копирования невозможна. Можно:
- Сделать фото экрана другим устройством
- Использовать специализированные инструменты
- Обойти через модификацию браузера

Это решение **значительно усложняет** копирование, но не делает его невозможным. Основная цель - отслеживание утечек через водяные знаки и усложнение массового копирования.
